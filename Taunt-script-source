local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local pgui = player:WaitForChild("PlayerGui")
local camera = workspace.CurrentCamera

-- Zmienne stanu
local char, torso, humanoid
local isTaunting = false
local isAdrenaline = false
local isUsingAbility = false -- Blokada tylko na czas trwania akcji
local onCooldownAdrenaline = false
local onCooldownTaunt = false

local hitStreak = 0 
local startTime = 0
local tauntDuration = 5
local adrenalineCooldownTime = 15

local function setupCharacter(newChar)
	char = newChar
	torso = char:WaitForChild("Torso")
	humanoid = char:WaitForChild("Humanoid")
	isTaunting = false
	isAdrenaline = false
	isUsingAbility = false
end

player.CharacterAdded:Connect(setupCharacter)
if player.Character then setupCharacter(player.Character) end

-- GUI
local screenGui = pgui:FindFirstChild("DeltaAbilityGui") or Instance.new("ScreenGui")
screenGui.Name = "DeltaAbilityGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = pgui

local container = screenGui:FindFirstChild("BtnContainer") or Instance.new("Frame")
container.Name = "BtnContainer"
container.Size = UDim2.new(0, 210, 0, 100)
container.Position = UDim2.new(0.5, -105, 0.7, -10)
container.BackgroundTransparency = 1
container.Parent = screenGui

local function createStyledButton(name, text, pos)
	local btn = container:FindFirstChild(name) or Instance.new("TextButton")
	btn.Name = name
	btn.Size = UDim2.new(0, 100, 0, 100)
	btn.Position = pos
	btn.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
	btn.Text = text
	btn.Font = Enum.Font.Arcade
	btn.TextColor3 = Color3.fromRGB(255, 255, 255)
	btn.TextScaled = true
	btn.Parent = container
	if not btn:FindFirstChild("UIStroke") then
		local s = Instance.new("UIStroke", btn)
		s.Thickness = 3
		Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 10)
	end
	return btn
end

local tauntBtn = createStyledButton("TauntBtn", "TAUNT", UDim2.new(0, 0, 0, 0))
local adrenalineBtn = createStyledButton("AdrenalineBtn", "ADRENALINE", UDim2.new(0, 110, 0, 0))

local tauntSound = Instance.new("Sound", pgui); tauntSound.SoundId = "rbxassetid://108614786727784"
local hitSound = Instance.new("Sound", pgui); hitSound.SoundId = "rbxassetid://97113622160405"
local failSound = Instance.new("Sound", pgui); failSound.SoundId = "rbxassetid://127614493691795"
local adrStartSnd = Instance.new("Sound", pgui); adrStartSnd.SoundId = "rbxassetid://72676700836497"
local adrEndSnd = Instance.new("Sound", pgui); adrEndSnd.SoundId = "rbxassetid://129528425379076"

local function restoreJoints()
	if not char or not torso then return end
	local limbs = {ra = char:FindFirstChild("Right Arm"), la = char:FindFirstChild("Left Arm"), rl = char:FindFirstChild("Right Leg"), ll = char:FindFirstChild("Left Leg")}
	if not limbs.ra then return end
	local function make(n, p0, p1, c0, c1)
		local j = torso:FindFirstChild(n) or Instance.new("Motor6D")
		j.Name = n; j.Part0 = p0; j.Part1 = p1; j.C0 = c0; j.C1 = c1; j.Parent = p0
	end
	make("Right Shoulder", torso, limbs.ra, CFrame.new(1, 0.5, 0) * CFrame.Angles(0, math.rad(90), 0), CFrame.new(-0.5, 0.5, 0) * CFrame.Angles(0, math.rad(90), 0))
	make("Left Shoulder", torso, limbs.la, CFrame.new(-1, 0.5, 0) * CFrame.Angles(0, math.rad(-90), 0), CFrame.new(0.5, 0.5, 0) * CFrame.Angles(0, math.rad(-90), 0))
	make("Right Hip", torso, limbs.rl, CFrame.new(1, -1, 0) * CFrame.Angles(0, math.rad(90), 0), CFrame.new(0.5, 1, 0) * CFrame.Angles(0, math.rad(90), 0))
	make("Left Hip", torso, limbs.ll, CFrame.new(-1, -1, 0) * CFrame.Angles(0, math.rad(-90), 0), CFrame.new(-0.5, 1, 0) * CFrame.Angles(0, math.rad(-90), 0))
end

local function setLimb(limb, torsoCF, offset, rot)
	if limb and limb.Parent and torsoCF then
		limb.CFrame = torsoCF * offset * rot * CFrame.new(0, -0.5, 0)
	end
end

RunService.RenderStepped:Connect(function()
	if not char or not torso or not torso.Parent then return end
	local cf = torso.CFrame
	if isTaunting then
		local wave = math.sin((tick() - startTime) * 20) * math.rad(45)
		setLimb(char:FindFirstChild("Right Arm"), cf, CFrame.new(1.5, 0.5, 0), CFrame.Angles(math.rad(180) + wave, 0, 0))
		setLimb(char:FindFirstChild("Left Arm"), cf, CFrame.new(-1.5, 0.5, 0), CFrame.Angles(math.rad(180) - wave, 0, 0))
		setLimb(char:FindFirstChild("Right Leg"), cf, CFrame.new(0.5, -1.5, 0), CFrame.Angles(-wave, 0, 0))
		setLimb(char:FindFirstChild("Left Leg"), cf, CFrame.new(-0.5, -1.5, 0), CFrame.Angles(wave, 0, 0))
	elseif isAdrenaline then
		local e = tick() - startTime
		local up, stay, down = 0.5, 1.0, 0.5
		local alpha = e <= up and e/up or e <= up+stay and 1 or e <= up+stay+down and 1-((e-up-stay)/down) or 0
		local rX, rZ = math.rad(240)*alpha, math.rad(15)*alpha
		setLimb(char:FindFirstChild("Right Arm"), cf, CFrame.new(1.5, 0.5, 0), CFrame.Angles(rX, 0, rZ))
		setLimb(char:FindFirstChild("Left Arm"), cf, CFrame.new(-1.5, 0.5, 0), CFrame.Angles(rX, 0, -rZ))
	end
end)

-- LOGIKA ADRENALINY
adrenalineBtn.MouseButton1Click:Connect(function()
	if isUsingAbility or onCooldownAdrenaline or not humanoid or humanoid.Health <= 0 then return end
	isUsingAbility, isAdrenaline, onCooldownAdrenaline, startTime = true, true, true, tick()
	adrStartSnd:Play()
	
	adrenalineBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
	TweenService:Create(adrenalineBtn, TweenInfo.new(adrenalineCooldownTime, Enum.EasingStyle.Linear), {BackgroundColor3 = Color3.fromRGB(80, 80, 80)}):Play()

	if torso:FindFirstChild("Right Shoulder") then torso["Right Shoulder"]:Destroy() end
	if torso:FindFirstChild("Left Shoulder") then torso["Left Shoulder"]:Destroy() end

	humanoid.WalkSpeed = 32
	local oldFOV = camera.FieldOfView
	TweenService:Create(camera, TweenInfo.new(0.5), {FieldOfView = oldFOV * 1.35}):Play()
	
	task.delay(2, function() 
		isAdrenaline = false
		restoreJoints()
		isUsingAbility = false -- Można użyć taunta podczas trwania speed boosta!
	end)

	task.delay(7, function()
		humanoid.WalkSpeed = 0
		adrEndSnd:Play()
		TweenService:Create(camera, TweenInfo.new(1), {FieldOfView = oldFOV}):Play()
		task.wait(3)
		humanoid.WalkSpeed = 16
		task.delay(adrenalineCooldownTime - 10, function() onCooldownAdrenaline = false end)
	end)
end)

-- LOGIKA TAUNTA
tauntBtn.MouseButton1Click:Connect(function()
	if isUsingAbility or onCooldownTaunt or not humanoid or humanoid.Health <= 0 then return end
	isUsingAbility, isTaunting, onCooldownTaunt, startTime = true, true, true, tick()
	tauntSound:Play()
	humanoid.WalkSpeed = 0
	
	tauntBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
	TweenService:Create(tauntBtn, TweenInfo.new(7, Enum.EasingStyle.Linear), {BackgroundColor3 = Color3.fromRGB(80, 80, 80)}):Play()

	for _, n in pairs({"Right Shoulder", "Left Shoulder", "Right Hip", "Left Hip"}) do
		if torso:FindFirstChild(n) then torso[n]:Destroy() end
	end

	task.spawn(function()
		local hitDetected = false
		local phaseTimes = {0.7, 1.4, 2.1}
		local radii = {3, 6, 9}

		for i = 1, 3 do
			task.wait(0.7)
			if not isTaunting then break end
			for _, other in pairs(Players:GetPlayers()) do
				if other ~= player and other.Character and other.Character:FindFirstChild("Torso") then
					if (torso.Position - other.Character.Torso.Position).Magnitude <= radii[i] then
						hitDetected = true; break
					end
				end
			end
			if hitDetected then break end
		end

		if hitDetected then
			isTaunting = false; tauntSound:Stop(); restoreJoints()
			hitSound.PlaybackSpeed = math.min(1 + (hitStreak * 0.1), 1.5); hitSound:Play()
			hitStreak = hitStreak + 1; humanoid.WalkSpeed = 24
			local oldFOV = camera.FieldOfView
			TweenService:Create(camera, TweenInfo.new(0.5), {FieldOfView = oldFOV * 1.25}):Play()
			task.delay(5, function()
				humanoid.WalkSpeed = 16
				TweenService:Create(camera, TweenInfo.new(1.5), {FieldOfView = oldFOV}):Play()
			end)
			isUsingAbility = false
		else
			-- Jeśli nie trafił, czekaj do końca tauntDuration (5s)
			local remaining = tauntDuration - (tick() - startTime)
			if remaining > 0 then task.wait(remaining) end
			
			hitStreak = 0; failSound:Play()
			isTaunting = false; restoreJoints(); humanoid.WalkSpeed = 16
			isUsingAbility = false
		end
		
		task.delay(7, function() onCooldownTaunt = false end)
	end)
end)
